<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <!-- Theme initialiser: runs before paint to avoid flash -->
  <script>
    (function(){
      var t = localStorage.getItem('fliplearnTheme') || 'light';
      document.documentElement.setAttribute('data-theme', t);
    })();
  </script>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{% block title %}FlipLearn â€“ CSE Flipped Classroom Platform{% endblock %}</title>
  {% load static %}
  <link rel="icon" type="image/svg+xml" href="{% static 'images/logo.svg' %}"/>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" crossorigin="anonymous"/>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- marked.js + highlight.js for AI chat markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <link rel="stylesheet" href="{% static 'css/style.css' %}"/>
  {% block extra_css %}{% endblock %}
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm sticky-top">
  <div class="container-fluid px-4">
    <a class="navbar-brand fw-bold fs-5 d-flex align-items-center gap-2" href="{% url 'home' %}">
      <img src="{% static 'images/logo.svg' %}" alt="FlipLearn Logo"
           style="height:38px;width:38px;background:rgba(255,255,255,0.12);border-radius:8px;padding:3px;">
      <span>FlipLearn
        <small class="text-warning ms-1" style="font-size:0.6rem;vertical-align:super;">CSE</small>
      </span>
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
      <span class="navbar-toggler-icon"></span>
    </button>
    <!-- Dark Mode Toggle -->
    <button id="darkModeToggle" class="ms-2 d-flex align-items-center gap-1" title="Toggle dark / light mode">
      <i class="bi bi-moon-stars-fill" id="darkModeIcon"></i>
      <span id="darkModeLabel">Dark</span>
    </button>
    <div class="collapse navbar-collapse" id="navMain">
      {% if user.is_authenticated %}
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="{% url 'dashboard' %}"><i class="bi bi-grid me-1"></i>Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'videos' %}"><i class="bi bi-play-circle me-1"></i>Videos</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'materials' %}"><i class="bi bi-file-earmark-text me-1"></i>Materials</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'quizzes' %}"><i class="bi bi-patch-question me-1"></i>Quizzes</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'assignments' %}"><i class="bi bi-journal-code me-1"></i>Assignments</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'subjects' %}"><i class="bi bi-book me-1"></i>Subjects</a></li>
        {% if user.is_staff or user.teacher_profile %}
        <li class="nav-item"><a class="nav-link text-warning fw-semibold" href="{% url 'analytics' %}"><i class="bi bi-graph-up me-1"></i>Analytics</a></li>
        {% else %}
        <li class="nav-item"><a class="nav-link" href="{% url 'my_performance' %}"><i class="bi bi-bar-chart me-1"></i>My Performance</a></li>
        {% endif %}
      </ul>
      <ul class="navbar-nav ms-auto align-items-center">
        <!-- Notifications -->
        {% if notifications %}
        <li class="nav-item dropdown me-2">
          <a class="nav-link position-relative" href="#" data-bs-toggle="dropdown">
            <i class="bi bi-bell-fill fs-5"></i>
            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
              {{ notifications.count }}
            </span>
          </a>
          <ul class="dropdown-menu dropdown-menu-end" style="width:320px">
            <li><h6 class="dropdown-header">Notifications</h6></li>
            {% for n in notifications %}
            <li>
              <a class="dropdown-item small py-2" href="{% url 'mark_read' n.id %}">
                <i class="bi bi-exclamation-triangle-fill text-warning me-1"></i>{{ n.message|truncatechars:80 }}
              </a>
            </li>
            {% endfor %}
          </ul>
        </li>
        {% endif %}
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" data-bs-toggle="dropdown">
            <span class="avatar-circle me-2">{{ user.first_name|first|upper }}{{ user.last_name|first|upper }}</span>
            {{ user.get_full_name|default:user.username }}
          </a>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><span class="dropdown-item-text text-muted small">{{ user.email }}</span></li>
            <li><hr class="dropdown-divider"></li>
            <li>
              <form method="post" action="{% url 'logout' %}" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="dropdown-item text-danger">
                  <i class="bi bi-box-arrow-right me-2"></i>Logout
                </button>
              </form>
            </li>
          </ul>
        </li>
      </ul>
      {% else %}
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="{% url 'login' %}">Login</a></li>
        <li class="nav-item"><a class="btn btn-warning btn-sm ms-2" href="{% url 'register' %}">Register</a></li>
      </ul>
      {% endif %}
    </div>
  </div>
</nav>

<!-- Messages -->
{% if messages %}
<div class="container-fluid px-4 mt-2">
  {% for msg in messages %}
  <div class="alert alert-{{ msg.tags|default:'info' }} alert-dismissible fade show shadow-sm" role="alert">
    <i class="bi bi-info-circle-fill me-2"></i>{{ msg }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  {% endfor %}
</div>
{% endif %}

<!-- Main Content -->
<main class="container-fluid px-4 py-3">
  {% block content %}{% endblock %}
</main>

<!-- â”€â”€ Auto-Logout: hidden POST form â”€â”€ -->
{% if user.is_authenticated %}
<form id="autoLogoutForm" method="post" action="{% url 'logout' %}" class="d-none">
  {% csrf_token %}
</form>

<!-- Inactivity warning toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:9999">
  <div id="inactivityToast" class="toast align-items-center text-bg-warning border-0 shadow-lg" role="alert"
       data-bs-autohide="false" style="min-width:320px;">
    <div class="d-flex">
      <div class="toast-body fs-6">
        <i class="bi bi-clock-history me-2"></i>
        <strong>Still there?</strong> You'll be logged out in
        <strong id="toastCountdown">60</strong>s due to inactivity.
        <div class="mt-2">
          <button id="stayLoggedInBtn" class="btn btn-sm btn-dark me-2">
            <i class="bi bi-hand-thumbs-up me-1"></i>Stay Logged In
          </button>
          <button onclick="document.getElementById('autoLogoutForm').submit()"
                  class="btn btn-sm btn-outline-dark">
            <i class="bi bi-box-arrow-right me-1"></i>Logout Now
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Pass logout config to JS -->
<script>
  window.FLIPLEARN = {
    INACTIVITY_TIMEOUT : 5 * 60 * 1000,   // 5 minutes total
    WARNING_BEFORE     : 60 * 1000,        // show warning 60 s before logout
    logoutFormId       : 'autoLogoutForm',
    toastId            : 'inactivityToast',
    countdownId        : 'toastCountdown',
    stayBtnId          : 'stayLoggedInBtn'
  };
</script>
{% endif %}

<!-- Footer -->
<footer class="site-footer mt-5">
  <div class="footer-top">
    <div class="container-fluid px-4 px-md-5">
      <div class="row g-4 py-5">

        <!-- Brand & About -->
        <div class="col-12 col-md-6 col-lg-4">
          <div class="d-flex align-items-center gap-2 mb-3">
            {% load static %}
            <img src="{% static 'images/logo.svg' %}" alt="FlipLearn"
                 style="height:40px;width:40px;border-radius:10px;padding:4px;background:rgba(255,255,255,0.08);">
            <span class="fw-bold fs-5 footer-brand">
              FlipLearn <small class="text-warning" style="font-size:0.55rem;vertical-align:super;">CSE</small>
            </span>
          </div>
          <p class="footer-desc mb-3">
            An AI/ML-powered flipped classroom platform for M.Tech CSE students.
            Learn before class, practise during class, and let machine learning
            predict your performance.
          </p>
          <div class="d-flex gap-2 flex-wrap">
            <span class="footer-badge"><i class="bi bi-mortarboard-fill me-1"></i>M.Tech CSE</span>
            <span class="footer-badge"><i class="bi bi-robot me-1"></i>ML-Powered</span>
            <span class="footer-badge"><i class="bi bi-shield-check me-1"></i>Research 2026</span>
          </div>
        </div>

        <!-- Quick Links -->
        <div class="col-6 col-md-3 col-lg-2">
          <h6 class="footer-heading">Platform</h6>
          <ul class="footer-links">
            <li><a href="{% url 'home' %}"><i class="bi bi-house me-2"></i>Home</a></li>
            {% if user.is_authenticated %}
            <li><a href="{% url 'dashboard' %}"><i class="bi bi-grid me-2"></i>Dashboard</a></li>
            <li><a href="{% url 'videos' %}"><i class="bi bi-play-circle me-2"></i>Videos</a></li>
            <li><a href="{% url 'quizzes' %}"><i class="bi bi-patch-question me-2"></i>Quizzes</a></li>
            <li><a href="{% url 'assignments' %}"><i class="bi bi-journal-code me-2"></i>Assignments</a></li>
            {% else %}
            <li><a href="{% url 'login' %}"><i class="bi bi-box-arrow-in-right me-2"></i>Login</a></li>
            <li><a href="{% url 'register' %}"><i class="bi bi-person-plus me-2"></i>Register</a></li>
            {% endif %}
          </ul>
        </div>

        <!-- Learning -->
        <div class="col-6 col-md-3 col-lg-2">
          <h6 class="footer-heading">Learning</h6>
          <ul class="footer-links">
            <li><a href="{% url 'subjects' %}"><i class="bi bi-book me-2"></i>Subjects</a></li>
            <li><a href="{% url 'materials' %}"><i class="bi bi-file-earmark-text me-2"></i>Materials</a></li>
            <li><a href="{% url 'videos' %}"><i class="bi bi-camera-video me-2"></i>Video Lectures</a></li>
            {% if user.is_authenticated %}
            {% if user.is_staff %}
            <li><a href="{% url 'analytics' %}"><i class="bi bi-graph-up me-2"></i>Analytics</a></li>
            {% else %}
            <li><a href="{% url 'my_performance' %}"><i class="bi bi-bar-chart me-2"></i>My Performance</a></li>
            {% endif %}
            {% endif %}
          </ul>
        </div>

        <!-- Research Info -->
        <div class="col-12 col-lg-4">
          <h6 class="footer-heading">Research Project</h6>
          <div class="footer-info-card">
            <div class="footer-info-row">
              <i class="bi bi-person-badge-fill"></i>
              <div>
                <div class="footer-info-label">Researcher</div>
                <div class="footer-info-value">Uttam Vitthal Bhise</div>
              </div>
            </div>
            <div class="footer-info-row">
              <i class="bi bi-building"></i>
              <div>
                <div class="footer-info-label">Programme</div>
                <div class="footer-info-value">M.Tech â€“ Computer Science &amp; Engineering</div>
              </div>
            </div>
            <div class="footer-info-row">
              <i class="bi bi-journal-text"></i>
              <div>
                <div class="footer-info-label">Research Topic</div>
                <div class="footer-info-value">Performance Analysis of the Flipped Classroom Model using AI/ML</div>
              </div>
            </div>
            <div class="footer-info-row">
              <i class="bi bi-calendar3"></i>
              <div>
                <div class="footer-info-label">Academic Year</div>
                <div class="footer-info-value">2025 â€“ 2026</div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Footer bottom bar -->
  <div class="footer-bottom">
    <div class="container-fluid px-4 px-md-5">
      <div class="d-flex flex-column flex-md-row align-items-center justify-content-between gap-2 py-3">
        <small class="footer-copy">
          &copy; 2026 <strong>FlipLearn</strong> â€” Flipped Classroom Platform. All rights reserved.
        </small>
        <div class="d-flex align-items-center gap-3">
          <span class="footer-tech-badge"><i class="bi bi-bootstrap-fill me-1"></i>Bootstrap 5</span>
          <span class="footer-tech-badge"><i class="bi bi-braces me-1"></i>Django</span>
          <span class="footer-tech-badge"><i class="bi bi-robot me-1"></i>scikit-learn</span>
        </div>
        <small class="footer-copy">
          Built with <i class="bi bi-heart-fill text-danger mx-1"></i> for CSE Education
        </small>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
{% load static %}
<script src="{% static 'js/main.js' %}"></script>
{% block extra_js %}{% endblock %}

{% if user.is_authenticated %}
<!-- â”€â”€ FlipLearn AI Chat Widget â€” Perplexity style â”€â”€â”€â”€â”€â”€â”€ -->
<!-- Backdrop -->
<div id="chatBackdrop" class="chat-backdrop"></div>

<div id="flipChatWidget">
  <!-- PIP Button -->
  <button id="flipChatPip" class="chat-pip" title="Ask FlipLearn AI" aria-label="Open AI Tutor">
    <i class="bi bi-robot chat-pip-icon"></i>
    <span class="chat-pip-label">AI Tutor</span>
    <span id="chatUnreadBadge" class="chat-unread-badge d-none">!</span>
  </button>

  <!-- Chat Panel (right sidebar) -->
  <div id="flipChatPanel" class="chat-panel" aria-live="polite" role="region" aria-label="FlipLearn AI Tutor">
    <!-- Header -->
    <div class="chat-panel-header">
      <div class="d-flex align-items-center gap-2">
        <i class="bi bi-robot fs-5"></i>
        <div>
          <div class="fw-bold lh-1">FlipLearn AI</div>
          <small class="chat-online-indicator"><span class="chat-dot"></span> Online</small>
        </div>
      </div>
      <div class="d-flex gap-2">
        <button id="chatClearBtn" class="chat-header-btn" title="Clear history">
          <i class="bi bi-trash3"></i>
        </button>
        <button id="chatCloseBtn" class="chat-header-btn" title="Close">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
    </div>

    <!-- Subject Filter -->
    <div class="chat-subject-bar">
      <label class="chat-subject-label"><i class="bi bi-funnel me-1"></i>Subject:</label>
      <select id="chatSubjectSelect" class="chat-subject-select">
        <option value="">All Subjects</option>
        <option value="DS">Data Structures</option>
        <option value="PY">Python Programming</option>
        <option value="WD">Web Development</option>
        <option value="CN">Computer Networks</option>
        <option value="DSC">Data Science</option>
        <option value="AI">AI &amp; ML</option>
      </select>
    </div>

    <!-- Messages -->
    <div id="chatMessages" class="chat-messages">
      <!-- Welcome block -->
      <div class="chat-welcome" id="chatWelcome">
        <div class="chat-welcome-icon"><i class="bi bi-robot"></i></div>
        <h5 class="chat-welcome-title">Hi {{ user.first_name|default:user.username }}, I'm FlipLearn AI</h5>
        <p class="chat-welcome-sub">Ask me anything about your M.Tech CSE subjects â€” I'll search the knowledge base and answer with sources.</p>
        <div class="chat-suggestions" id="chatSuggestions">
          <button class="chat-suggestion-chip" data-q="Explain AVL tree rotations with examples">AVL Tree Rotations</button>
          <button class="chat-suggestion-chip" data-q="What is the difference between TCP and UDP?">TCP vs UDP</button>
          <button class="chat-suggestion-chip" data-q="How does backpropagation work in neural networks?">Backpropagation</button>
          <button class="chat-suggestion-chip" data-q="Explain binary search tree operations">BST Operations</button>
          <button class="chat-suggestion-chip" data-q="What is overfitting and how do you prevent it?">Overfitting</button>
          <button class="chat-suggestion-chip" data-q="How does Python's GIL work?">Python GIL</button>
          <button class="chat-suggestion-chip" data-q="Explain Dijkstra's shortest path algorithm">Dijkstra's Algorithm</button>
          <button class="chat-suggestion-chip" data-q="What are the key components of a transformer model?">Transformers</button>
          <button class="chat-suggestion-chip" data-q="Explain CSS Flexbox vs Grid">Flexbox vs Grid</button>
          <button class="chat-suggestion-chip" data-q="What is the bias-variance tradeoff?">Bias-Variance Tradeoff</button>
        </div>
      </div>
    </div>

    <!-- Typing area -->
    <!-- PDF attachment badge (hidden until file chosen) -->
    <div id="chatPdfBadge" class="chat-pdf-badge d-none">
      <i class="bi bi-file-earmark-pdf-fill"></i>
      <span id="chatPdfName">file.pdf</span>
      <button id="chatPdfRemove" title="Remove PDF">&times;</button>
    </div>
    <div class="chat-input-area">
      <input type="file" id="chatPdfInput" accept=".pdf,.docx,.doc" class="d-none">
      <button id="chatUploadBtn" class="chat-upload-btn" title="Upload PDF or Word file to explain">
        <i class="bi bi-paperclip"></i>
      </button>
      <textarea
        id="chatInput"
        class="chat-input"
        rows="1"
        placeholder="Ask a questionâ€¦ (Enter to send)"
        maxlength="1000"
        aria-label="Your question"
      ></textarea>
      <button id="chatSendBtn" class="chat-send-btn" title="Send">
        <i class="bi bi-send-fill"></i>
      </button>
    </div>
    <div class="chat-panel-footer">
      Powered by <strong>Groq LLaMA-3</strong> + FAISS Â· <span id="chatCharCount">0</span>/1000
    </div>
  </div>
</div>

<script>
(function () {
  /* â”€â”€ configure marked.js â”€â”€ */
  if (typeof marked !== 'undefined') {
    marked.setOptions({
      breaks: true,
      gfm: true,
      highlight: (code, lang) => {
        if (typeof hljs !== 'undefined') {
          const valid = lang && hljs.getLanguage(lang);
          return valid ? hljs.highlight(code, {language: lang}).value
                       : hljs.highlightAuto(code).value;
        }
        return code;
      }
    });
  }
  function renderMd(text) {
    if (typeof marked !== 'undefined') {
      return marked.parse(text || '');
    }
    return String(text || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
  }

  const pip      = document.getElementById('flipChatPip');
  const panel    = document.getElementById('flipChatPanel');
  const backdrop = document.getElementById('chatBackdrop');
  const closeBtn = document.getElementById('chatCloseBtn');
  const clearBtn = document.getElementById('chatClearBtn');
  const sendBtn  = document.getElementById('chatSendBtn');
  const input    = document.getElementById('chatInput');
  const msgs     = document.getElementById('chatMessages');
  const subjectSel = document.getElementById('chatSubjectSelect');
  const charCount  = document.getElementById('chatCharCount');
  const badge      = document.getElementById('chatUnreadBadge');
  const uploadBtn  = document.getElementById('chatUploadBtn');
  const pdfInput   = document.getElementById('chatPdfInput');
  const pdfBadge   = document.getElementById('chatPdfBadge');
  const pdfName    = document.getElementById('chatPdfName');
  const pdfRemove  = document.getElementById('chatPdfRemove');
  const CSRF_TOKEN = '{{ csrf_token }}';
  let isOpen = false;
  let isLoading = false;
  let unread = 0;
  let pendingPdf = null;   // holds the File object when a PDF is staged

  /* â”€â”€ open / close â”€â”€ */
  function openPanel() {
    isOpen = true;
    panel.classList.add('chat-panel-open');
    pip.classList.add('chat-pip-active');
    backdrop.classList.add('chat-backdrop-show');
    unread = 0;
    badge.classList.add('d-none');
    setTimeout(() => input.focus(), 350);
    scrollBottom();
  }
  function closePanel() {
    isOpen = false;
    panel.classList.remove('chat-panel-open');
    pip.classList.remove('chat-pip-active');
    backdrop.classList.remove('chat-backdrop-show');
  }
  pip.addEventListener('click', () => isOpen ? closePanel() : openPanel());
  closeBtn.addEventListener('click', closePanel);
  backdrop.addEventListener('click', closePanel);
  document.addEventListener('keydown', e => { if (e.key === 'Escape' && isOpen) closePanel(); });

  /* â”€â”€ input helpers â”€â”€ */
  input.addEventListener('input', () => {
    charCount.textContent = input.value.length;
    input.style.height = 'auto';
    input.style.height = Math.min(input.scrollHeight, 140) + 'px';
  });
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  });
  sendBtn.addEventListener('click', sendMessage);

  /* â”€â”€ clear â”€â”€ */
  clearBtn.addEventListener('click', () => {
    msgs.innerHTML = '';
    const w = document.createElement('div');
    w.className = 'chat-answer';
    w.innerHTML = '<p style="color:var(--chat-sub)">History cleared. Ask me anything! ðŸ˜Š</p>';
    msgs.appendChild(w);
  });

  function scrollBottom() {
    setTimeout(() => { msgs.scrollTop = msgs.scrollHeight; }, 30);
  }
  function escapeHtml(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  /* â”€â”€ suggestion chips â”€â”€ */
  function wireChips(root) {
    root.querySelectorAll('.chat-suggestion-chip, .chat-related-chip').forEach(btn => {
      btn.addEventListener('click', () => {
        const q = btn.getAttribute('data-q') || btn.textContent.trim();
        input.value = q;
        charCount.textContent = q.length;
        input.style.height = 'auto';
        input.style.height = Math.min(input.scrollHeight, 140) + 'px';
        const sugBox = document.getElementById('chatSuggestions');
        if (sugBox) sugBox.style.display = 'none';
        const welcome = document.getElementById('chatWelcome');
        if (welcome) welcome.style.display = 'none';
        sendMessage();
      });
    });
  }
  wireChips(document);

  /* â”€â”€ add user query block â”€â”€ */
  function addUserQuery(text) {
    const div = document.createElement('div');
    div.className = 'chat-user-query';
    div.innerHTML = `<span class="chat-user-query-icon"><i class="bi bi-person-circle"></i></span><span>${escapeHtml(text)}</span>`;
    msgs.appendChild(div);
    scrollBottom();
    return div;
  }

  /* â”€â”€ add searching indicator â”€â”€ */
  function addSearching() {
    const div = document.createElement('div');
    div.className = 'chat-searching';
    div.id = 'chatSearching';
    div.innerHTML = `<span class="chat-searching-dots"><span></span><span></span><span></span></span> Searching knowledge baseâ€¦`;
    msgs.appendChild(div);
    scrollBottom();
    return div;
  }
  function removeSearching() {
    const el = document.getElementById('chatSearching');
    if (el) el.remove();
  }

  /* â”€â”€ create answer block (returned so we can stream into it) â”€â”€ */
  function createAnswerBlock() {
    const wrap = document.createElement('div');
    wrap.className = 'chat-answer-wrap';

    const ansDiv = document.createElement('div');
    ansDiv.className = 'chat-answer';

    const header = document.createElement('div');
    header.className = 'chat-answer-header';
    header.innerHTML = '<i class="bi bi-robot me-1"></i><strong>FlipLearn AI</strong>';

    const textDiv = document.createElement('div');
    textDiv.className = 'chat-answer-text';

    ansDiv.appendChild(header);
    ansDiv.appendChild(textDiv);
    wrap.appendChild(ansDiv);
    msgs.appendChild(wrap);
    scrollBottom();
    return { wrap, textDiv };
  }

  /* â”€â”€ source cards â”€â”€ */
  function addSourceCards(wrap, sources) {
    if (!sources || sources.length === 0) return;
    const row = document.createElement('div');
    row.className = 'chat-source-cards';
    let knowledgeIdx = 0;
    sources.forEach((s) => {
      const isWiki = s.source_type === 'wikipedia';
      const isWeb  = s.source_type === 'web';
      const isLink = isWiki || isWeb;
      const card = document.createElement(isLink ? 'a' : 'div');
      card.className = 'chat-source-card' +
        (isWiki ? ' chat-source-card-wiki' : '') +
        (isWeb  ? ' chat-source-card-web'  : '');
      if (isLink) {
        card.href   = s.url;
        card.target = '_blank';
        card.rel    = 'noopener noreferrer';
      }
      if (isWiki) {
        card.title = 'Open on Wikipedia';
        card.innerHTML =
          `<span class="chat-source-wiki-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="13" height="13" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17.93V18c0-.55-.45-1-1-1s-1 .45-1 1v1.93C7.06 19.44 4.56 16.94 4.07 13H6c.55 0 1-.45 1-1s-.45-1-1-1H4.07C4.56 7.06 7.06 4.56 11 4.07V6c0 .55.45 1 1 1s1-.45 1-1V4.07c3.94.49 6.44 2.99 6.93 6.93H18c-.55 0-1 .45-1 1s.45 1 1 1h1.93c-.49 3.94-2.99 6.44-6.93 6.93z"/></svg></span>` +
          `<span class="chat-source-title">${escapeHtml(s.title || s)}</span>` +
          `<span class="chat-source-subject chat-source-subject-wiki">Wikipedia</span>`;
      } else if (isWeb) {
        card.title = `Open: ${s.url || ''}`;
        card.innerHTML =
          `<span class="chat-source-web-icon"><i class="bi bi-globe2"></i></span>` +
          `<span class="chat-source-title">${escapeHtml(s.title || s)}</span>` +
          `<span class="chat-source-subject chat-source-subject-web">Web</span>`;
      } else {
        knowledgeIdx++;
        card.innerHTML =
          `<span class="chat-source-num">${knowledgeIdx}</span>` +
          `<span class="chat-source-title">${escapeHtml(s.title || s)}</span>` +
          (s.subject ? `<span class="chat-source-subject">${escapeHtml(s.subject)}</span>` : '');
      }
      row.appendChild(card);
    });
    wrap.appendChild(row);
    scrollBottom();
  }

  /* â”€â”€ related question chips â”€â”€ */
  function addRelatedQuestions(wrap, questions) {
    if (!questions || questions.length === 0) return;
    const sec = document.createElement('div');
    sec.className = 'chat-related';
    sec.innerHTML = '<div class="chat-related-label"><i class="bi bi-arrow-right-circle me-1"></i>Related questions</div>';
    const row = document.createElement('div');
    row.className = 'chat-related-chips';
    questions.forEach(q => {
      const btn = document.createElement('button');
      btn.className = 'chat-related-chip';
      btn.setAttribute('data-q', q);
      btn.textContent = q;
      row.appendChild(btn);
    });
    sec.appendChild(row);
    wrap.appendChild(sec);
    wireChips(wrap);
    scrollBottom();
  }

  /* â”€â”€ PDF upload wiring â”€â”€ */
  uploadBtn.addEventListener('click', () => pdfInput.click());
  pdfInput.addEventListener('change', () => {
    const file = pdfInput.files[0];
    if (!file) return;
    const name = file.name.toLowerCase();
    if (!name.endsWith('.pdf') && !name.endsWith('.docx') && !name.endsWith('.doc')) {
      alert('Only PDF and Word (.docx) files are supported.');
      pdfInput.value = '';
      return;
    }
    pendingPdf = file;
    pdfName.textContent = file.name;
    pdfBadge.classList.remove('d-none');
    // Icon: word files get a different colour
    const isWord = file.name.toLowerCase().match(/\.docx?$/);
    pdfBadge.querySelector('i').className = isWord
      ? 'bi bi-file-earmark-word-fill'
      : 'bi bi-file-earmark-pdf-fill';
    input.placeholder = `Ask about this ${isWord ? 'Word doc' : 'PDF'}â€¦ or just press Send to explain it`;
    input.focus();
  });
  pdfRemove.addEventListener('click', () => {
    pendingPdf = null;
    pdfInput.value = '';
    pdfBadge.classList.add('d-none');
    input.placeholder = 'Ask a questionâ€¦ (Enter to send)';
  });

  /* â”€â”€ PDF upload & explain â”€â”€ */
  async function sendPDF() {
    const query = input.value.trim();
    if (!pendingPdf || isLoading) return;

    const welcome = document.getElementById('chatWelcome');
    if (welcome) welcome.style.display = 'none';

    // Show user message
    const isWordFile = pendingPdf.name.toLowerCase().match(/\.docx?$/);
    const label = query || `Explain ${isWordFile ? 'Word doc' : 'PDF'}: ${pendingPdf.name}`;
    addUserQuery(label);

    // Show file badge in chat
    const pdfMsgDiv = document.createElement('div');
    pdfMsgDiv.className = 'chat-pdf-msg';
    const fileIcon = isWordFile ? 'bi-file-earmark-word-fill' : 'bi-file-earmark-pdf-fill';
    pdfMsgDiv.innerHTML = `<i class="bi ${fileIcon}"></i> <span>${escapeHtml(pendingPdf.name)}</span>`;
    msgs.appendChild(pdfMsgDiv);
    scrollBottom();

    const fileToSend = pendingPdf;
    // Clear the staged PDF
    pendingPdf = null;
    pdfInput.value = '';
    pdfBadge.classList.add('d-none');
    input.value = '';
    input.placeholder = 'Ask a questionâ€¦ (Enter to send)';
    charCount.textContent = '0';
    input.style.height = 'auto';
    isLoading = true;
    sendBtn.disabled = true;
    uploadBtn.disabled = true;

    addSearching();
    const { wrap, textDiv } = createAnswerBlock();
    const sourcesData = [];
    let accumulated = '';
    let streamStarted = false;

    try {
      const formData = new FormData();
      formData.append('pdf_file', fileToSend);
      if (query) formData.append('query', query);

      const response = await fetch('{% url "chat_pdf" %}', {
        method: 'POST',
        headers: { 'X-CSRFToken': CSRF_TOKEN },
        body: formData,
      });

      if (!response.ok) {
        const err = await response.json().catch(() => ({error: `HTTP ${response.status}`}));
        throw new Error(err.error || `HTTP ${response.status}`);
      }
      if (!response.body) throw new Error('No response stream');

      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';

      while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream: true });
        let newlineIdx;
        while ((newlineIdx = buffer.indexOf('\n\n')) !== -1) {
          const line = buffer.slice(0, newlineIdx).trim();
          buffer = buffer.slice(newlineIdx + 2);
          if (!line.startsWith('data:')) continue;
          let payload;
          try { payload = JSON.parse(line.slice(5).trim()); } catch { continue; }
          if (payload.type === 'sources') {
            removeSearching(); streamStarted = true;
            sourcesData.push(...(payload.sources || []));
          } else if (payload.type === 'token') {
            if (!streamStarted) { removeSearching(); streamStarted = true; }
            accumulated += payload.text;
            textDiv.innerHTML = renderMd(accumulated);
            if (typeof hljs !== 'undefined') {
              textDiv.querySelectorAll('pre code:not([data-highlighted])').forEach(el => {
                hljs.highlightElement(el); el.setAttribute('data-highlighted','true');
              });
            }
            scrollBottom();
          } else if (payload.type === 'done') {
            textDiv.innerHTML = renderMd(accumulated);
            if (typeof hljs !== 'undefined') {
              textDiv.querySelectorAll('pre code:not([data-highlighted])').forEach(el => hljs.highlightElement(el));
            }
            addSourceCards(wrap, sourcesData);
            if (!isOpen) { unread++; badge.textContent = unread; badge.classList.remove('d-none'); }
          } else if (payload.type === 'error') {
            removeSearching();
            textDiv.innerHTML = `<p class="text-danger"><i class="bi bi-exclamation-triangle me-1"></i>${escapeHtml(payload.text)}</p>`;
          }
        }
      }
    } catch (err) {
      removeSearching();
      textDiv.innerHTML = `<p class="text-danger"><i class="bi bi-wifi-off me-1"></i>${escapeHtml(String(err))}</p>`;
    } finally {
      if (!streamStarted) removeSearching();
      isLoading = false;
      sendBtn.disabled = false;
      uploadBtn.disabled = false;
      input.focus();
    }
  }

  async function sendMessage() {
    // If a PDF is staged, delegate to sendPDF()
    if (pendingPdf) { sendPDF(); return; }

    const query = input.value.trim();
    if (!query || isLoading) return;

    const welcome = document.getElementById('chatWelcome');
    if (welcome) welcome.style.display = 'none';

    addUserQuery(query);
    input.value = '';
    charCount.textContent = '0';
    input.style.height = 'auto';
    isLoading = true;
    sendBtn.disabled = true;

    addSearching();

    const { wrap, textDiv } = createAnswerBlock();
    const sourcesData = [];
    let accumulated = '';
    let streamStarted = false;

    try {
      const response = await fetch('{% url "chat_stream" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': CSRF_TOKEN,
        },
        body: JSON.stringify({ query, subject_code: subjectSel.value }),
      });

      if (!response.ok || !response.body) throw new Error(`HTTP ${response.status}`);

      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';

      while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream: true });

        let newlineIdx;
        while ((newlineIdx = buffer.indexOf('\n\n')) !== -1) {
          const line = buffer.slice(0, newlineIdx).trim();
          buffer = buffer.slice(newlineIdx + 2);

          if (!line.startsWith('data:')) continue;
          let payload;
          try { payload = JSON.parse(line.slice(5).trim()); } catch { continue; }

          if (payload.type === 'sources') {
            removeSearching();
            streamStarted = true;
            sourcesData.push(...(payload.sources || []));
          } else if (payload.type === 'token') {
            if (!streamStarted) { removeSearching(); streamStarted = true; }
            accumulated += payload.text;
            textDiv.innerHTML = renderMd(accumulated);
            // apply syntax highlighting to new code blocks
            if (typeof hljs !== 'undefined') {
              textDiv.querySelectorAll('pre code:not([data-highlighted])').forEach(el => {
                hljs.highlightElement(el);
                el.setAttribute('data-highlighted', 'true');
              });
            }
            scrollBottom();
          } else if (payload.type === 'related') {
            addRelatedQuestions(wrap, payload.questions);
          } else if (payload.type === 'done') {
            // final render
            textDiv.innerHTML = renderMd(accumulated);
            if (typeof hljs !== 'undefined') {
              textDiv.querySelectorAll('pre code:not([data-highlighted])').forEach(el => { hljs.highlightElement(el); });
            }
            addSourceCards(wrap, sourcesData);
            if (!isOpen) { unread++; badge.textContent = unread; badge.classList.remove('d-none'); }
          } else if (payload.type === 'error') {
            removeSearching();
            textDiv.innerHTML = `<p class="text-danger"><i class="bi bi-exclamation-triangle me-1"></i>${escapeHtml(payload.text)}</p>`;
          }
        }
      }
    } catch (err) {
      removeSearching();
      textDiv.innerHTML = `<p class="text-danger"><i class="bi bi-wifi-off me-1"></i>Network error: ${escapeHtml(String(err))}</p>`;
    } finally {
      if (!streamStarted) removeSearching();
      isLoading = false;
      sendBtn.disabled = false;
      input.focus();
    }
  }

  /* â”€â”€ Load recent history on first open â”€â”€ */
  let historyLoaded = false;
  pip.addEventListener('click', () => {
    if (isOpen && !historyLoaded) {
      historyLoaded = true;
      fetch('{% url "chat_history" %}')
        .then(r => r.json())
        .then(data => {
          if (data.messages && data.messages.length > 1) {
            msgs.innerHTML = '';
            data.messages.forEach(m => {
              if (m.role === 'user') {
                addUserQuery(m.content);
              } else {
                const { wrap, textDiv } = createAnswerBlock();
                textDiv.innerHTML = renderMd(m.content);
                const srcList = m.sources ? m.sources.split(',').map(s => ({ title: s.trim(), subject: '' })).filter(s => s.title) : [];
                addSourceCards(wrap, srcList);
              }
            });
          }
        })
        .catch(() => {});
    }
  });
})();
</script>
{% endif %}
</body>
</html>
